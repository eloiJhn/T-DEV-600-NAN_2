name: Integration Tests

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '11'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.2'

      - name: Install Dependencies
        run: flutter pub get

      - name: Run Android Integration Tests
        env:
          apiLevel: "34"
          target: "google_apis"
          arch: "x86"
          deviceName: "android_emulator"
          deviceType: "pixel"
          FLAVOR: "prod"
        run: |
          sdkmanager "platform-tools" "platforms;android-${apiLevel}"
          sdkmanager --install "system-images;android-${apiLevel};${target}${arch}"
          sdkmanager --update
          echo "y" | sdkmanager --licenses
          echo "no" | avdmanager -v create avd --force --name "${deviceName}" --package "system-images;android-${apiLevel};${target};${arch}" --tag "${target}" --sdcard 128M --device "${deviceType}"
          emulator -avd "${deviceName}" -no-audio -no-window -no-snapstorage -no-snapshot -gpu swiftshader_indirect -no-boot-anim -no-accel -wipe-data -skip-adb-auth &
          adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done; input keyevent 82'
          flutter doctor -v
          set +e
          (flutter drive --driver=test_driver/integration_test.dart --target=integration_test/main.dart --flavor ${FLAVOR} || true) > e2e_output.log 2>&1 | (grep -q "Failed to uninstall app" && (echo "Failed to uninstall app." && exit 0))
          set -e
          cat e2e_output.log | grep -q "Some tests failed." && (echo "Some tests failed. Exiting with error code." >&2 && exit 1)

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: e2e-logs
          path: e2e_output.log
